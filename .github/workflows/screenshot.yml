name: Generate Demo GIF

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install VHS and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd
          go install github.com/charmbracelet/vhs@latest

      # Download pre-built autofwd binary
      - name: Download autofwd binary
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: release.yml
          name: autofwd-x86_64-unknown-linux-gnu
          path: .
          branch: main
          check_artifacts: true
          search_artifacts: true

      - name: Extract autofwd
        run: |
          tar xzf autofwd-x86_64-unknown-linux-gnu.tar.gz
          chmod +x autofwd
          sudo mv autofwd /usr/local/bin/
          autofwd --help

      - name: Build test Docker image
        run: docker build -t autofwd-test-ssh crates/autofwd/tests/docker

      - name: Generate SSH key and config
        run: |
          ssh-keygen -t ed25519 -f /tmp/demo_key -N ""
          mkdir -p ~/.ssh
          cat > ~/.ssh/config << 'EOF'
          Host demo
            HostName localhost
            Port 2222
            User testuser
            IdentityFile /tmp/demo_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: Start demo container with mock services
        run: |
          docker run -d \
            --name demo \
            -p 2222:22 \
            -v /tmp/demo_key.pub:/home/testuser/.ssh/authorized_keys:ro \
            autofwd-test-ssh

          sleep 3

          # Mock services with fake process names
          docker exec demo sh -c 'cp /usr/bin/nc /tmp/python3; while true; do echo -e "HTTP/1.1 200 OK\r\n\r\nHello" | /tmp/python3 -l -p 3000 -q 1 2>/dev/null; done &'
          docker exec demo sh -c 'cp /usr/bin/nc /tmp/postgres; while true; do /tmp/postgres -l -p 5432 -q 1 2>/dev/null; done &'
          docker exec demo sh -c 'cp /usr/bin/nc /tmp/redis-server; while true; do echo "+PONG" | /tmp/redis-server -l -p 6379 -q 1 2>/dev/null; done &'

          sleep 2

      - name: Run VHS
        run: vhs docs/demo.tape

      - name: Verify GIF
        run: |
          ls -lh docs/demo.gif
          file docs/demo.gif

      - name: Cleanup
        if: always()
        run: docker rm -f demo || true

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update demo GIF [skip ci]"
          file_pattern: "docs/*.gif"
